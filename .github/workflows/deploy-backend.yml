name: Deploy Vendure Backend to Azure VM

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Azure VM
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          VM_USER: ${{ secrets.VM_USER }}
          VM_IP: ${{ secrets.VM_IP }}
          APP_PATH: ${{ secrets.VM_APP_PATH }}
          
        run: |
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
  
          ssh-keyscan -H $VM_IP >> ~/.ssh/known_hosts 2>/dev/null
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $VM_USER@$VM_IP << 'DEPLOY_SCRIPT'
  
          cd $APP_PATH
          git pull origin main
          npm install
          npm run build
          pm2 restart vendure-backend
          pm2 save
          DEPLOY_SCRIPT
